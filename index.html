<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description"
        content="Sankalp Suchi is a simple and efficient todo app to organize tasks, boost productivity, and manage your daily goalsâ€”all in one place.">
    <title> To Do App </title>
    <link rel="icon" href="icons/favicon.ico" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json" />
    <link rel="stylesheet" href="main.css">
</head>

<body>
    <script>
        class NotificationHandler {
            constructor() {
                this.checkInterval = 360000; // 1hr
                this.lastNotificationTime = 0;
                this.hasPermission = false;
                this.initialize();
            }

            async initialize() {
                try {
                    if (!("Notification" in window)) {
                        console.log("This browser does not support notifications");
                        return;
                    }

                    // Check current permission status
                    if (Notification.permission === "granted") {
                        this.hasPermission = true;
                        this.startNotificationSystem();
                    } else {
                        // Show permission button if not granted
                        this.createPermissionButton();
                    }
                } catch (error) {
                    console.error("Error initializing notifications:", error);
                }
            }

            createPermissionButton() {
                const button = document.createElement('button');
                button.innerHTML = 'ðŸ”” Enable Notifications';
                button.className = 'btn btn-primary m-2';
                button.style.position = 'fixed';
                button.style.bottom = '20px';
                button.style.right = '20px';
                button.style.zIndex = '1000';

                button.addEventListener('click', async () => {
                    try {
                        const permission = await Notification.requestPermission();
                        if (permission === "granted") {
                            this.hasPermission = true;
                            button.remove();
                            this.startNotificationSystem();
                            this.showNotification("Notifications Enabled!", "You'll now receive reminders about your tasks.");
                        }
                    } catch (error) {
                        console.error("Error requesting permission:", error);
                    }
                });

                document.body.appendChild(button);
            }

            startNotificationSystem() {
                setInterval(() => this.checkTasks(), this.checkInterval);

                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        this.checkTasks();
                    }
                });

                setTimeout(() => this.checkTasks(), 60000);
            }

            async checkTasks() {
                try {
                    if (!this.hasPermission) return;

                    const now = Date.now();
                    if (now - this.lastNotificationTime < this.checkInterval) {
                        return;
                    }

                    const incompleteTasks = JSON.parse(localStorage.getItem('task-list')) || [];
                    console.log(`Checking tasks: ${incompleteTasks.length} incomplete tasks found`);

                    if (incompleteTasks.length > 0) {
                        await this.showNotification(
                            "Pending Tasks",
                            `You have ${incompleteTasks.length} task${incompleteTasks.length === 1 ? '' : 's'} to complete!`
                        );
                        this.lastNotificationTime = now;
                    }
                } catch (error) {
                    console.error("Error checking tasks:", error);
                }
            }

            async showNotification(title, message) {
                try {
                    if (!this.hasPermission) return;

                    if ("serviceWorker" in navigator && navigator.serviceWorker.ready) {
                        const registration = await navigator.serviceWorker.ready;
                        await registration.showNotification(title, {
                            body: message,
                            icon: "/icons/maskable-icon.png",
                            badge: "/icons/favicon.ico",
                            tag: "todo-reminder",
                            requireInteraction: true,
                            vibrate: [200, 100, 200],
                            actions: [
                                {
                                    action: 'view',
                                    title: 'ðŸ‘€ View Tasks'
                                },
                                {
                                    action: 'dismiss',
                                    title: 'âŒ Dismiss'
                                }
                            ]
                        });
                    } else {
                        new Notification(title, {
                            body: message,
                            icon: "/icons/maskable-icon.png"
                        });
                    }
                } catch (error) {
                    console.error("Error showing notification:", error);
                }
            }
        }

        if ("serviceWorker" in navigator) {
            window.addEventListener("load", async () => {
                try {
                    const registration = await navigator.serviceWorker.register("./sw.js");
                    console.log("Service Worker registered:", registration);
                    window.notificationHandler = new NotificationHandler();
                } catch (error) {
                    console.error("Service Worker registration failed:", error);
                }
            });
        }
    </script>
    <div class="outer-container">
        <div id="todo" class="glass">
            <div class="container appname d-flex align-items-center" role="banner">
                <img src="icons/maskable-icon.png" alt="Todo Logo" height="50" width="48" /> &nbsp; &nbsp;&nbsp;
                <h1> Sankalp Suchi </h1>
            </div>
            <div class="container d-flex align-items-center justify-content-center todo-input-box" id="taskinput" role="main">
                <div class="task-wrap container d-flex">
                    <input type="text" id="task" placeholder="Add a task" />
                    <span class="underline"></span>
                </div>
                <button id="add" aria-label="Add task button" class="add-btn btn"> 
                    <img src="icons/plus-solid.svg" alt="Add Task" style="filter: invert(1); width: 24px; height: 24px;"/>
                </button>
            </div>
            <div class="container p-4" id="tasklist" role="main">
                <div class=" container glass p-3">
                    <div class="progress-container">
                        <h1> Let's go ! ðŸ”¥âœ¨ </h1>
                        <div class="circle">
                            <span id="tasksDone" style="font-size: 38px;">0 / 0</span><!-- <h1 style="padding: 30px; border: 2px solid black; border-radius: 80%;"> 0/1</h1> -->
                        </div>
                    </div>
                    <progress id="task-progress" value="0" max="100" style="width: 100%;"></progress>
                </div>
                <br/><br />
                <h2> Your Tasks :</h2>
                <hr style="border: 2px solid white;"/>
                <div id="listitems"></div>
            </div>
            <div class="container p-4" id="comp-tasklist" role="main">
                <h2> Completed Tasks :</h2>
                <hr style="border: 2px solid white;" />
                <div id="comp-listitems"></div>
            </div>
            <div class="container p-4 d-flex justify-content-center gap-3" role="button">
                <button id="clearIncomplete" class="btn btn-warning p-2" style="color: white;" onclick="clearIncompleteTasks()">Clear Incomplete Tasks</button>
                <button id="clearall" class="btn btn-danger p-2" onclick="clearAllTasks()">Clear All Tasks</button>
                <button id="clearComplete" class="btn btn-success p-2" onclick="clearCompletedTasks()">Clear Completed Tasks</button>
            </div>
        </div>
        <div>
            
        </div>
    </div>
    <script src="myscript.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tsparticles/confetti@3.0.3/tsparticles.confetti.bundle.min.js"></script>
</body>
</html>